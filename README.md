# AI 기반 섹터 로테이션 & 가치주 발굴 시스템

## CURRENT STATUS (2026-01-16)

**Main Notebook**: Proper_Validation.ipynb
**Focus**: Model validation with proper train/test split (no data leakage)

**Quick Start**:
```bash
cd "/Users/yu_seok/Documents/workspace/nbCamp/Project/Yahoo Finance"
conda activate py_study
jupyter notebook Proper_Validation.ipynb
# Then: Cell > Run All
```

**Data Split**:
- Training: 2020-2024 (no data leakage)
- Testing: 2025 (hold-out test)
- Backtest: 2022, 2023, 2024 (independent validation)

**Models Compared**:
1. Prophet baseline
2. Prophet + XGBoost hybrid

**Old notebooks**: Moved to archived/ directory for reference

---

## 1. 프로젝트 정의

**"현재 시장을 주도하는 섹터를 식별하고, 머신러닝을 통해 해당 섹터 내에서 리스크 대비 상승 여력이 높은 '숨겨진 저평가 종목'을 발굴하는 자동화 분석 시스템"**

### 기획 의도 및 타겟

- **타겟** :
- **니즈** : 시장의 소음을 제거하고, 데이터에 기반한 **'옥석 가리기'** 자동화.
- **핵심 가치** :

1. **Top-Down 접근** : 숲(주도 섹터)을 먼저 보고 나무(개별 종목)를 고르는 정석 투자 전략 구현.
2. **데이터 무결성** : 데이터 누수 및 논리적 오류가 완벽히 제거된 고품질 금융 데이터 구축.
3. **Actionable Insight** : 단순 현황판이 아닌, "오늘 무엇을 사야 하는가?"에 대한 구체적 리스트(Top 5) 제공.

---

## 2. 데이터 아키텍처

### 데이터 개요

- **Core Data** : 2018 ~ 2023년 대규모 주식 데이터 (약 60만 행, Yahoo Finance 기반).
- **Live Extension** : **`yfinance` API 파이프라인을 통해2024 ~ 2025년 최신 데이터 실시간 연동** .
- **Coverage** : S&P 500 등 주요 우량 기업 500개 사 및 섹터 메타데이터.

---

## 3. 데이터 품질 엔지니어링

금융 데이터 분석의 신뢰도를 결정짓는 **6가지 치명적 결함을 발견하고 해결**하여 무결성을 확보했습니다.

| **구분**             | **문제점**                                                | **해결 솔루션**                                          |
| -------------------- | --------------------------------------------------------- | -------------------------------------------------------- |
| **1. 논리 오류**     | 고가(High)가 저가(Low)보다 낮은 논리적 모순 데이터 (30건) | `clean_ohlc_violations()` 함수로 논리에 맞게 값 보정     |
| **2. 데이터 누수**   | A기업 종가가 B기업 수익률 계산에 반영되는 치명적 오류     | `groupby('Company')` 적용으로 기업별 독립 연산 수행      |
| **3. 정밀도 이슈**   | 부동소수점 오차로 인한 데이터 오검출                      | `validate_ohlc_with_tolerance()` (허용 오차 0.01) 도입   |
| **4. 극단값 관리**   | 50% 이상 폭락/폭등 등 실제 블랙스완 이벤트                | 삭제하지 않고 `Is_Extreme_Change` 플래그를 생성하여 보존 |
| **5. 거래량 0 보정** | API 한계 및 상장 초기 이슈로 인한 거래량 0 레코드 (329건) | 실제 히스토리컬 데이터 수동 확인 후 값 보정 (14개 종목)  |
| **6. 섹터 필터링**   | Sector 정보 결측 시 섹터별 분석 신뢰도 저하               | Unknown 및 결측 Sector 데이터 제거 (분석 전제조건 확립)  |

### 거래량 0 보정 상세 내역

총 14개 기업, 329건의 결함 데이터를 실제 거래량으로 대체했습니다.

- **주요 대상** : FERG (316건, 상장 초기 데이터 누락), BKR, CCI, CHD, CNC, DB (데이터 수집 오류), IBKR, NWG, SYM, MBLY, GOLD 등.
- **보정 방법** : Yahoo Finance 원본 데이터 재대조 후 결측값을 실제값으로 매핑.

---

## 4. 파생변수 엔지니어링

모델링 성능 향상과 다각적 분석을 위해 원본 OHLCV 데이터로부터 생성된 파생 변수 정의입니다.

### 4.1 수익률 및 모멘텀

주가의 변동 성과와 추세 강도를 측정합니다.

- **Daily_Return_raw** : 일별 수익률. 통계 분석 및 ML 모델 입력용으로, 첫 데이터의 NaN 값을 유지하여 데이터 왜곡을 방지합니다.
- **Daily_Return_calc** : 누적 수익률 계산을 위해 첫 NaN 값을 0으로 대체한 보조 변수입니다.
- **Cum_Return** : 누적 수익률. 특정 시점부터 현재까지의 총 수익률 성과를 나타냅니다.
- **Return_1M / 3M / 6M** : 각각 최근 20일, 60일, 120일간의 수익률 변화를 측정하여 단기 및 중기 모멘텀을 파악합니다.

### 4.2 추세 지표

주가의 전반적인 방향성을 파악합니다.

- **MA_5 / 20 / 60** : 각각 5일(단기), 20일(중기/심리선), 60일(장기/수급선) 이동평균선입니다. 초기 구간의 부정확성을 배제하기 위해 윈도우 크기만큼의 최소 기간을 설정했습니다.

### 4.3 변동성 및 리스크

투자의 위험도와 가격 변동 폭을 측정합니다.

- **Volatility_20d** : 연환산 변동성. 최근 20일 일별 수익률의 표준편차에 `sqrt(252)`를 곱하여 연간 기준으로 변환했습니다.
- **Drawdown** : 최근 1년(252일) 내 고점 대비 현재 주가의 하락률입니다.
- **MDD (Maximum Drawdown)** : 최근 1년 동안 발생한 Drawdown 중 최대 낙폭값입니다. 해당 종목 보유 시 겪을 수 있는 최대 리스크를 의미합니다.

### 4.4 거래량 및 수급

시장의 관심도와 유동성을 파악하며, 머신러닝 학습을 위해 분포를 정규화했습니다.

- **Vol_Ratio** : 당일 거래량이 20일 평균 대비 얼마나 급증했는지 비율로 나타냅니다.
- **Vol_Z_Score** : 거래량의 통계적 이례성을 표준점수로 측정합니다.
- **Log_Volume_W** : 거래량 데이터의 왜도를 완화하기 위해 로그 변환 후, 상하위 1% 값을 캡핑하여 이상치에 의한 모델 왜곡을 방지했습니다.

### 4.5 기술적 지표

매매 타이밍 결정을 위한 보조지표입니다.

- **RSI_14** : 14일 기준 상대강도지수. 과매수(70 이상)와 과매도(30 이하) 구간을 식별합니다.
- **Bollinger Bands (Upper/Middle/Lower)** : 20일 이동평균선을 중심으로 표준편차의 2배 범위 내에 주가가 위치하는지 분석합니다.
- **BB_Width** : 볼린저 밴드의 폭. 변동성의 축소와 확대 국면을 파악하는 데 사용됩니다.

---

## 5. AI 모델링 아키텍처

단순한 시계열 예측의 한계를 극복하기 위해, 거시적 추세와 비선형적 오차를 분리하여 예측하는 **Prophet + XGBoost 하이브리드 모델**을 구축했습니다.

### 5.1 하이브리드 알고리즘

전통적인 시계열 모델의 강점과 머신러닝의 정밀함을 결합하여 예측 정확도를 극대화합니다.

1. **Base Prediction (Prophet)** : 계절성과 전반적인 추세를 1차적으로 예측합니다.
2. **Residual Correction (XGBoost)** : 1차 예측의 오차(잔차, `Actual - Prophet`)를 계산하고, 이를 XGBoost로 학습하여 미세한 변동성을 보정합니다.
3. **Final Ensemble** : `Prophet 예측값 + XGBoost 잔차 예측값`을 합산하여 최종 주가 및 수익률을 도출합니다.

### 5.2 멀티 호라이즌 예측

단일 시점이 아닌 다양한 투자 기간에 대응하기 위해 4가지 시간 지평을 동시에 예측합니다.

| **Horizon**   | **기간**   | **목적**                              |
| ------------- | ---------- | ------------------------------------- |
| **2 Weeks**   | 10 거래일  | 단기 트레이딩 및 모멘텀 포착          |
| **1 Month**   | 20 거래일  | 월간 리밸런싱 및 스윙 전략            |
| **1 Quarter** | 60 거래일  | 분기 실적 시즌 대비 및 중기 추세 확인 |
| **1 Year**    | 252 거래일 | 장기 투자 및 연간 자산 배분 전략      |

### 5.3 모델 파이프라인 구조

예측 시스템은 실험과 양산을 분리하여 모듈화되었습니다.

- **Integrated Analyzer (`07_Integrated_Prophet_Analysis`)** : 데이터 전처리부터 모델 학습, 하이브리드 결합 실험을 총괄하는 오케스트레이션 모듈입니다.
- **Pipeline Engine (`multi_horizon_predictor.py`)** : 연도별 학습/테스트 분할과 호라이즌별 루프를 수행하며, 최종적으로 **'통합 예측 테이블'** 을 생성하여 랭킹 시스템(LTR)으로 데이터를 넘깁니다.

---

## 6. 분석 로직: 탑다운(Top-Down) 3단계 프로세스

본 프로젝트는 **"Where to Play(어디서) → Who is Best(무엇을)"** 의 흐름을 따릅니다.

### Step 1. 주도 섹터 식별 (Where?)

- **방법** :**AI 하이브리드 모델(Prophet+XGBoost)** 기반 섹터별 기대 수익률 예측.
- **목표** : 향후 1개월(1M) 및 1분기(1Q) 기준, 상승 추세가 가장 뚜렷한 **'Top 3 주도 섹터'** 를 선정합니다.

### Step 2. 종목 군집화 (Clustering)

- **방법** :**K-Means Clustering** 알고리즘 적용 (입력 변수: Log_Volume_W, Volatility_20d, Return_3M 등).
- **목표** : 섹터 내 산업들을 성격별(예: 고성장 공격형 vs 안정형 가치주 vs 소외주)로 그룹화합니다.

### Step 3. 옥석 가리기 (Screening)

- **방법** : **Risk-Reward 산점도** 분석 및 AI 예측 신뢰도 검증.
- **목표** : 주도 섹터 및 유망 클러스터 내에서 '변동성(Risk/MDD)은 낮고 기대수익(Return/Momentum)은 높은'**저평가 Top 5 종목**을 최종 추출합니다.

---

## 7. 대시보드 활용 계획

사용자의 의사결정 흐름에 맞춘 3단계 화면을 제공합니다.

- **Page 1 (Market Flow)** : 섹터 로테이션 히트맵 & 랭킹 차트 (현재 시장의 자금 흐름 파악).
- **Page 2 (Screening - Main)** : Risk-Reward 스캐터 플롯 & 클러스터링 결과 (저평가 우량주 발굴).
- ~~**Page 3 (Deep Dive)** : 개별 종목의 AI 예측(Prophet) 차트, 매수 근거 지표(RSI, BB Width 등) 상세 시각화.~~
