# [Project] 미국 주식 데이터 기반 멀티 호라이즌 섹터 로테이션 및 산업 클러스터링 시스템

---

## 1. 프로젝트 배경 및 정의

### 1.1 배경: "시장은 뉴스보다 빠르다"

미국 시장은 금리, 인플레이션, 지정학적 이슈 등 수많은 거시 변수에 의해 움직입니다. 하지만 개인 투자자가 이 모든 변수를 실시간으로 분석하여 금리의 향방을 예측하는 것은 불가능에 가깝습니다.

본 프로젝트는 거시 변수를 예측하려는 시도 대신, **시장이 보여주는 '추세 강도'의 변화를 실시간으로 추적**하여 자금이 쏠리는 주도 섹터에 객관적으로 편승합니다.

### 1.2 프로젝트 정의

**"미국 주식 시장의 방대한 OHLCV 데이터를 분석하여, 현재 자금이 집중되는 '주도 섹터'를 식별하고, 머신러닝을 통해 리스크 대비 상승 여력이 높은 '저평가 우량 산업'을 발굴하는 자동화 분석 시스템"**

* **Target Audience**: 감에 의존하지 않고, 오직 **데이터가 증명하는 추세**에 따라 포트폴리오를 조정하려는 스마트 투자자.
* **Core Value**:
  1. **Fact-Based**: 예측의 영역을 최소화하고, 시장이 보여주는 추세와 강도에 기반한 객관적 대응.
  2. **Top-Down Approach**: **숲(섹터)을 먼저 보고 나무(산업)를 고르는** 정석 투자 전략의 자동화.
  3. **Agile Rotation**: 7가지 멀티 호라이즌 분석을 통해 자금의 이동을 가장 빠르게 포착.

---

## 2. 핵심 철학 & 리스크 대응 전략

### 2.1 Prophet의 추세 전환 감지

* **상황**: 금리 인상 악재로 기술주(Tech)가 하락세로 전환될 경우.
* **대응**: Prophet 모델은 시계열 데이터에서 **'변곡점(Changepoints)'** 을 감지합니다. 최근 데이터의 하락 기울기가 급해지면, 향후 예측값($\hat{y}$)을 자동으로 하향 조정하여 해당 섹터를 추천 순위에서 즉시 배제합니다.

### 2.2 XGBoost의 잔차 보정

* **상황**: 갑작스러운 쇼크(지정학적 이슈, 금리 쇼크)로 시장이 급락하는 비선형적 상황.
* **대응**: 단순 추세 모델이 놓친 급격한 변동(잔차)을 XGBoost가 학습합니다. 최근 변동성이 확대된 것을 리스크 요인으로 반영하여 예측 보정을 수행합니다.

### 2.3 멀티 호라이즌의 민첩성

* **전략**: 장기(1년) 모델뿐만 아니라 **1일(1d), 3일(3d), 1주(1w)** 등 단기 모델이 병행 작동합니다.
* **효과**: 장기 추세가 완전히 무너지기 전, 단기 모델이 먼저 섹터 로테이션 신호(예: Tech 하락 $\rightarrow$ Energy 상승)를 포착하므로 **금리 변화 초기에 빠른 태세 전환** 이 가능합니다.

---

## 3. 데이터 아키텍처 및 품질 엔지니어링

### 3.1 데이터 개요

* **Core Data**: 2018 ~ 2023년 대규모 미국 주식 데이터 (Yahoo Finance 기반).
* **Live Extension**: `yfinance` API 파이프라인을 통해 최신 데이터 실시간 병합.
* **Scope**: S&P 500 주요 기업 및 GICS 섹터/산업 메타데이터.

### 3.2 데이터 무결성 확보 (6대 결함 해결)

금융 데이터 분석의 신뢰도를 결정짓는 치명적 결함을 사전 제거했습니다.

| **이슈**        | **설명**                        | **해결책**                                |
| :-------------------- | :------------------------------------ | :---------------------------------------------- |
| **논리 오류**   | High < Low 인 비정상 데이터 (30건)    | `clean_ohlc_violations()`로 값 보정           |
| **데이터 누수** | A기업 종가가 B기업 수익률 계산에 반영 | `groupby('Company')` 기반 독립 연산           |
| **정밀도 오류** | 부동소수점 오차로 인한 오검출         | `tolerance=0.01` 허용 오차 검증 도입          |
| **블랙스완**    | 50% 이상 폭락/폭등 (실제 충격)        | 삭제하지 않고 `Is_Extreme_Change` 플래그 보존 |
| **거래량 0**    | API 오류 및 거래 정지 (329건)         | 히스토리컬 데이터 교차 검증 및 보정             |
| **섹터 결측**   | Sector 정보 누락                      | Unknown 데이터 제거로 분석 전제 확립            |

---

## 4. 파생변수 엔지니어링

모델링 성능 향상과 다각적 분석을 위해 생성된 주요 파생 변수입니다.

* **Trend & Momentum**: `Daily_Return`, `Return_1M/3M/6M` (중단기 추세 확인)
* **Risk & Volatility**:
  * `Volatility_20d`: 연환산 변동성 (Risk 측정의 핵심)
  * `MDD`: 고점 대비 최대 하락폭 (하방 경직성 확인)
  * `Sharpe_Ratio`: 위험 대비 수익 효율성 (핵심 랭킹 지표)
* **Volume Analysis**: `Vol_Ratio`, `Vol_Z_Score` (수급 이탈/유입 감지)

---

## 5. AI 모델링 아키텍처 (Prophet + XGBoost)

단순 시계열 예측의 한계를 극복하기 위해, **거시적 추세(Trend)** 와 **미세 변동성(Noise)** 을 분리하여 학습합니다.

### 5.1 하이브리드 알고리즘 로직

1. **Base Prediction (Prophet)**: 계절성과 전반적인 우상향/우하향 추세를 1차 예측.
2. **Residual Correction (XGBoost)**: 1차 예측의 오차(잔차)를 학습하여 보정.
   * *설정*: $\alpha=0.6$ (최근 시장의 미세 변동성에 60% 가중치 부여)
3. **Final Output**: `(1-α)*Prophet + α*(Prophet + Residual)`

### 5.2 멀티 호라이즌 & 랭킹 엔진

* **7 Horizons**: 1D, 3D, 1W, 1M, 1Q, 6M, 1Y 기간을 독립적으로 예측.
* **Ranking**: `Score = z(prediction) + 0.5 * z(confidence)`
  * 수익률뿐만 아니라 모델의 예측 신뢰도까지 반영하여 Top-3 선정.

---

## 6. 인더스트리 클러스터링

선정된 주도 섹터 내에서도 **"무엇을 살 것인가?"** 를 결정하기 위해, 산업을 **Risk-Reward** 기준으로 5단계 분류합니다.

* **Cluster 1: Strong Buy (강력 매수)**

  * **정의**: **"Low Risk, High Return"** (가장 이상적인 투자처)
  * **조건**: $Sharpe \ge 1.5$ AND $Volatility < 40\%$
  * **전략**: 시장 상황과 무관하게 수급과 실적이 뒷받침되는 핵심 산업.
* **Cluster 0: Aggressive (고수익 추구)**

  * **정의**: **"High Risk, High Return"** (성장주, 모멘텀주)
  * **조건**: ($Sharpe \ge 1.0$ & $Vol \ge 30\%$ & $Return \ge 12\%$)
  * **전략**: 변동성은 높지만 강력한 상승 추세에 올라타는 전략.
* **Cluster 2: Stable (안정형)**

  * **정의**: **"Mid Return, Low Volatility"** (방어주)
  * **조건**: $0.5 \le Sharpe < 1.5$ AND $Vol < 25\%$
  * **전략**: 하락장 방어용 포트폴리오.

*(Cluster 3, 4는 투자 비효율/위험 구간으로 제외 권고)*

---

## 7. 시스템 출력 및 활용

파이프라인 실행 결과는 `Data_set/Cluster_Results/` 경로에 저장됩니다.

* **Output Files**:
  * `{date}_{horizon}_cluster_{n}.csv`: 호라이즌별/클러스터별 종목 리스트.
  * `{date}_{horizon}_industry_features.csv`: 산업별 지표 분석 원천 데이터.
* **Visualization**: Tableau와 연동하여 **섹터 로테이션 히트맵** 및 **Risk-Reward 산점도** 시각화.

---

## 8. 향후 발전 계획

1. **시각화 대시보드**: 클러스터별 Risk-Reward 산점도 대시보드화.
2. **포트폴리오 최적화**: Cluster 1 종목 간 상관계수를 분석하여 '최소 분산 포트폴리오' 자동 구성.
3. **LLM 리포팅**: 분석 결과를 바탕으로 생성형 AI가 "오늘의 투자 전략 리포트" 자동 작성.

---

## 9. 부록: 주요 용어 설명

* **yhat (예측값)** : AI 모델이 계산한 미래의 예상 가격 또는 수익률.
* **alpha (하이브리드 가중치)** : 전체 흐름(Prophet)과 미세 변동(XGBoost)의 반영 비율. 현재 0.6으로 설정하여 시장 변화 민감도를 높임.
* **Sharpe Ratio (샤프 지수)** : 위험 1단위당 얻을 수 있는 초과 수익. 이 시스템의 핵심 랭킹 지표.
* **Residual (잔차)** : 1차 모델이 설명하지 못한 오차. 이를 XGBoost로 재학습하여 예측력을 높임.
* **MDD (Maximum Drawdown)** : 고점 대비 최대 낙폭. 리스크 관리의 핵심 지표.
* **yhat (예측값)** : AI 모델이 계산한 미래의 예상 가격 또는 수익률입니다. 쉽게 말해, "내일 또는 다음 달에 이 주식의 값이 얼마가 될까?"라는 질문에 대한 AI의 답변입니다.
* **alpha (알파, 하이브리드 가중치)** : 두 가지 AI 모델(전체적인 흐름을 보는 Prophet과 미세한 변화를 잡는 XGBoost)의 의견을 어떤 비율로 섞을지 결정하는 값입니다. 현재 설정된**alpha=0.6**은 최근의 오차를 수정하는 데 더 큰 비중을 두어, 시장 변화에 더 민감하게 반응하도록 설계되었음을 뜻합니다.
* **gamma (감마, 신뢰도 가중치)** : 추천 순위를 정할 때 '높은 수익'과 '확실한 예측' 중 무엇을 더 중요하게 생각할지 정하는 기준입니다. 이 값이 높을수록 단순히 수익률만 높은 것보다, AI가 맞출 확률이 높다고 판단하는 안전한 대상을 상위권에 배치합니다.
* **MDD (Maximum Drawdown, 최대 낙폭)** : 투자 기간 중 최고점에서 최저점까지 얼마나 떨어졌는지를 나타내는 지표입니다. "내가 이 투자를 했을 때 겪을 수 있는 최악의 손실은 얼마인가?"를 보여주며, 수치가 0에 가까울수록 하락장에서 잘 버틴 산업입니다.
* **NDCG (Normalized Discounted Cumulative Gain, 순위 정확도)** : AI가 추천한 종목들의 순위가 실제 시장의 성과 순위와 얼마나 일치하는지 평가하는 점수입니다. 1점에 가까울수록 AI가 유망한 종목을 정확한 순서대로 잘 골라냈다는 뜻입니다.
* **Sharpe Ratio (샤프 지수, 투자 가성비)** : 위험(변동성)을 1만큼 감수했을 때 얻을 수 있는 추가 수익을 말합니다. 단순히 수익이 높은 것이 아니라, 얼마나 "효율적으로" 돈을 벌었는지 보여주는 지표로, 수치가 높을수록 가성비 좋은 투자처입니다.
* **Volatility (변동성)** : 가격이 위아래로 출렁이는 정도입니다. 변동성이 크다는 것은 짧은 시간에 큰 돈을 벌 수도 있지만, 반대로 큰 손해를 볼 위험도 크다는 것을 의미합니다.
* **Horizon (시간 지평)** : 분석 대상이 되는 미래의 기간입니다. 우리 시스템은 1일(1d)부터 1년(1y)까지 총 7가지 기간을 분석하여, 단기 투자자와 장기 투자자 모두에게 맞는 전략을 제공합니다.
* **Z-Score (표준 점수)** : 현재의 수치가 평소(평균)와 비교했을 때 얼마나 특별하게 높거나 낮은지를 나타내는 점수입니다. 서로 다른 기준을 가진 데이터들을 공평하게 비교하기 위해 사용합니다.
* **Residual (잔차, 예측 오차)** : 실제 결과와 AI의 예측값 사이의 차이입니다. 우리 시스템은 이 오차를 버리지 않고 다시 한번 학습하여, 모델이 놓친 미세한 패턴까지 잡아냅니다.
* **OHLCV** : 주식의 가격 움직임을 나타내는 5가지 핵심 데이터인 시가(Open), 고가(High), 저가(Low), 종가(Close), 거래량(Volume)의 약자입니다.
* **Residual Correction (잔차 보정)** : 첫 번째 모델(Prophet)이 놓친 오차를 두 번째 모델(XGBoost)이 보완하여 최종 예측의 정확도를 높이는 하이브리드 방식의 핵심 기술입니다.

---

## 10. 성과 지표 산출 기준

본 프로젝트는 AI 모델의 성능을 투명하게 검증하기 위해 다음과 같은 기준을 적용했습니다.

### 10.1 실제 수익률

백테스트 기간 동안 특정 섹터를 보유했을 때 실제로 얻었을 수익률입니다.

* **계산 방법** :`(마지막 날 종가 ÷ 첫날 종가) - 1`
* **예시** : 1월 1일에 100원이었던 섹터가 12월 31일에 120원이 되었다면 수익률은 **20%** 입니다.

### 10.2 Top-3 성과 지표 (Top-3 Metrics)

AI가 "가장 유망하다"고 예측한 상위 3개 섹터의 성적표입니다.

**1) Top-3 평균 수익률 (Average Return)**

* **의미** : "AI가 찍어준 3개만 샀다면, 평균적으로 얼마를 벌었는가?" (절대 수익)
* **계산** : AI가 예측한 상위 3개 섹터의 실제 수익률을 더해서 3으로 나눈 값.

**2) Top-3 초과 수익률 (Excess Return)**

* **의미** : "AI가 시장 평균(S&P 500 등)보다 얼마나 더 잘했는가?" (알파 창출 능력)
* **계산** :`Top-3 평균 수익률 - 시장 전체 평균 수익률`
* **플러스(+)** : 시장보다 돈을 더 잘 벌었다는 뜻.
* **마이너스(-)** : 그냥 시장 평균을 사는 게 나았다는 뜻.

### 10.3 샤프 지수 (Sharpe Ratio)

단순히 수익만 높은 게 아니라, **'위험 대비 얼마나 효율적으로 벌었는지'**를 나타내는**투자 가성비** 지표입니다.

* **의미** : 감수한 위험(변동성) 1단위당 얻은 초과 수익.
* **해석 기준** :
  * **1.5 이상** :**Strong Buy** (위험은 적고 수익은 높은 꿀통)
  * **1.0 ~ 1.5** :**Aggressive** (위험도 크지만 수익도 큼)
  * **1.0 미만** : 위험 대비 수익이 낮아 보수적 접근 필요

### 10.4 NDCG (순위 예측 정확도)

AI가 예측한 **순서(랭킹)** 가 얼마나 정확한지 평가하는 점수입니다.

* **의미** : "1등을 진짜 1등이라고 맞췄는가?"
* **특징** : 단순히 맞춘 개수만 보는 게 아니라,**상위권(1~3위)을 맞출수록 더 높은 점수**를 줍니다. (4, 5위를 틀리는 것보다 1위를 틀리는 것이 점수가 더 많이 깎입니다.)
* **해석** :
  * **1.0점** : 예측한 순위가 실제 결과와 완벽하게 일치함.
  * **0.8점 이상** : 매우 뛰어난 예측 성능.
  * **0.5점 미만** : 찍는 것과 비슷한 수준.
