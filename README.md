# AI 기반 멀티 호라이즌 섹터 로테이션 & 인더스트리 클러스터링 시스템

#### 0. 현재 구현사항

| **구분**        | **현재 구현**                                  |
| --------------------- | ---------------------------------------------------- |
| **섹터 선정**   | **각 호라이즌별 독립적인** Top-3 섹터 선정     |
| **클러스터링**  | **Rule-based Logic 기반** 5단계 산업 군집 분석 |
| **데이터 저장** | 호라이즌별 상세 데이터 (총 35개 CSV) 제공            |
| **분석 정밀도** | 시계열별 특화된 포트폴리오 전략 수립 가능            |
| **알고리즘**    | **Prophet + XGBoost 하이브리드** (잔차 보정)   |

---

## 1. 프로젝트 정의

**"현재 시장을 주도하는 섹터를 식별하고, 머신러닝을 통해 해당 섹터 내에서 리스크 대비 상승 여력이 높은 '숨겨진 저평가 산업'을 발굴하는 자동화 분석 시스템"**

### 기획 의도 및 타겟

* **타겟** : 데이터 기반의 정교한 섹터 로테이션 전략을 추구하는 퀀트 및 개인 투자자.
* **니즈** : 시장의 소음을 제거하고, 데이터에 기반한 **'옥석 가리기'** 자동화.
* **핵심 가치** :
  1. **Top-Down 접근** : 숲(주도 섹터)을 먼저 보고 나무(산업/종목)를 고르는 정석 투자 전략 구현.
  2. **멀티 호라이즌 분석** : 단기(1일)부터 장기(1년)까지 다양한 투자 시계(Time Horizon)에 최적화된 전략 제공.
  3. **Actionable Insight** : 단순 현황판이 아닌, "특정 기간 내에 어떤 산업군에 집중해야 하는가?"에 대한 구체적 리스트와 군집 분석 제공.

---

## 2. 데이터 아키텍처

### 데이터 개요

* **Core Data** : 2018 ~ 2023년 대규모 주식 데이터 (약 60만 행, Yahoo Finance 기반).
* **Live Extension** :`yfinance` API 파이프라인을 통해 최신 데이터 실시간 연동 가능.
* **Coverage** : S&P 500 등 주요 우량 기업 및 섹터/산업별 메타데이터.

---

## 3. 데이터 품질 엔지니어링

금융 데이터 분석의 신뢰도를 결정짓는**6가지 치명적 결함을 해결**하여 무결성을 확보했습니다.

| **구분**             | **문제점**                                          | **해결 솔루션**                                      |
| -------------------------- | --------------------------------------------------------- | ---------------------------------------------------------- |
| **1. 논리 오류**     | 고가(High)가 저가(Low)보다 낮은 논리적 모순 데이터 (30건) | `clean_ohlc_violations()` 함수로 논리에 맞게 값 보정     |
| **2. 데이터 누수**   | A기업 종가가 B기업 수익률 계산에 반영되는 치명적 오류     | `groupby('Company')` 적용으로 기업별 독립 연산 수행      |
| **3. 정밀도 이슈**   | 부동소수점 오차로 인한 데이터 오검출                      | `validate_ohlc_with_tolerance()` (허용 오차 0.01) 도입   |
| **4. 극단값 관리**   | 50% 이상 폭락/폭등 등 실제 블랙스완 이벤트                | 삭제하지 않고 `Is_Extreme_Change` 플래그를 생성하여 보존 |
| **5. 거래량 0 보정** | API 한계 및 상장 초기 이슈로 인한 거래량 0 레코드 (329건) | 실제 히스토리컬 데이터 수동 확인 후 값 보정 (14개 종목)    |
| **6. 섹터 필터링**   | Sector 정보 결측 시 섹터별 분석 신뢰도 저하               | Unknown 및 결측 Sector 데이터 제거 (분석 전제조건 확립)    |

---

## 4. 파생변수 엔지니어링

모델링 성능 향상과 다각적 분석을 위해 생성된 주요 파생 변수 정의입니다.

### 4.1 수익률 및 모멘텀

* **Daily_Return_raw** : 일별 수익률. 첫 데이터의 NaN 값을 유지하여 데이터 왜곡 방지.
* **Return_1M / 3M / 6M** : 각각 최근 20일, 60일, 120일간의 수익률 변화 (중단기 모멘텀).

### 4.2 변동성 및 리스크

* **Volatility_20d** : 연환산 변동성. 최근 20일 일별 수익률의 표준편차에 `sqrt(252)`를 곱하여 산출.
* **MDD (Maximum Drawdown)** : 특정 기간 내 고점 대비 최대 하락률. 종목의 하방 리스크를 측정.
* **Sharpe_Ratio** : 위험(변동성) 대비 수익률의 효율성을 나타내는 지표.

### 4.3 거래량 및 수급

* **Vol_Ratio** : 당일 거래량이 20일 평균 대비 얼마나 급증했는지의 비율.
* **Vol_Z_Score** : 거래량의 통계적 이례성을 표준점수로 측정.
* **Log_Volume_W** : 거래량 데이터의 왜도를 완화하기 위해 로그 변환 및 윈저라이징 적용.

---

## 5. AI 모델링 아키텍처

단순한 시계열 예측의 한계를 극복하기 위해, 거시적 추세와 비선형적 오차를 분리하여 예측하는**Prophet + XGBoost 하이브리드 모델**을 구축했습니다.

### 5.1 하이브리드 알고리즘

1. **Base Prediction (Prophet)** : 계절성과 전반적인 추세를 1차적으로 예측.
2. **Residual Correction (XGBoost)** : 1차 예측의 오차(잔차)를 XGBoost로 학습하여 미세한 변동성을 보정 (**alpha=0.6**은 최근 오차 보정에 60% 가중치를 부여함을 의미).
3. **Final Ensemble** :`(1 - alpha) * Prophet 예측값 + alpha * (Prophet 예측값 + XGBoost 잔차 예측값)`으로 최종 수익률 도출.

### 5.2 멀티 호라이즌 & 랭킹 엔진

* **7 Horizons** : 1D, 3D, 1W, 1M, 1Q, 6M, 1Y 기간을 동시에 독립적으로 예측.
* **Ranking Engine** :`z(prediction) + gamma * z(confidence)` 공식을 통해 수익률과 신뢰도를 동시에 고려한 최적 섹터 선정 ( **gamma=0.5** ).
* **Model Parameters** :
* **XGBoost** :`n_estimators=75`,`max_depth=3`,`learning_rate=0.07`
* **Training** :`train_years=4` (최근 4개년 데이터로 학습)
* **Key Features** :`yhat_lag_1`,`range_position`,`return_20d`,`month`,`trend_strength`,`return_5d`,`return_10d` 활용

### 5.3 인더스트리 클러스터링

선정된 상위 섹터 내 산업들을**Sharpe Ratio**와 **Volatility** 임계값을 기준으로**5개 그룹**으로 정밀 분류합니다. 기존의 단순 군집화 한계를 극복하여 성과 특성을 명확히 반영했습니다.

* **Cluster 0 (고수익·고위험, Aggressive)** :**"High Risk, High Return"**
  * 조건: (**$Sharpe \ge 1.0$** AND$Vol \ge 30\%$AND$Return \ge 12\%$) OR (**$Sharpe \ge 1.5$** AND$Vol \ge 40\%$)
  * 특징: 변동성은 높지만 강력한 수익 모멘텀을 보유한 성장 산업 (예: 반도체 장비, 우라늄 등).
* **Cluster 1 (강력 매수, Strong Buy)** :**"Low Risk, High Return"**
  * 조건:$Sharpe \ge 1.5$AND$Vol < 40\%$
  * 특징: 높은 투자 효율과 통제된 변동성을 가진 핵심 포트폴리오 대상.
* **Cluster 2 (안정형, Stable)** :**"Mid Return, Low Volatility"**
  * 조건:$0.5 \le Sharpe < 1.5$AND$Vol < 25\%$
  * 특징: 적절한 수익과 낮은 변동성을 가진 포트폴리오 방어주.
* **Cluster 3 (저수익·고위험, Inefficient)** :**"High Risk, Low Efficiency"**
  * 조건:$Sharpe \ge 0$(위 조건 미충족 시)
  * 특징: 변동성 대비 수익률이 낮거나(가치 함정), 수익 자체가 미미한 산업.
* **Cluster 4 (관망/주의, Caution)** :**"Negative Return"**
  * 조건:$Sharpe < 0$
  * 특징: 손실 구간에 진입하여 관망이 필요한 산업.

---

## 6. 분석 로직: 탑다운(Top-Down) 프로세스

### 6.1 호라이즌별 주도 섹터 식별

* 7가지 각 시간 지평별로 하이브리드 모델을 통해 상승 추세가 가장 뚜렷한 **'Top 3 주도 섹터'** 를 독립적으로 선정합니다.

### 6.2 산업별 군집 분석

* 기존의 상대적 거리 기반(K-Means) 방식에서**절대적 성과 지표 기반(Threshold-based)** 방식으로 로직을 고도화했습니다.
* 이로써 단순히 '비슷한 것끼리 묶는 것'이 아니라, **"실제 투자 매력도가 검증된 산업"** 을 정확히 필터링합니다.

### 6.3 옥석 가리기

* **Priority Target** : Cluster 1 (강력 매수) 및 Cluster 0 (고수익 추구)에 속한 산업을 최우선 분석 대상으로 추출합니다.
* **Avoid** : Cluster 3, 4에 속한 산업은 포트폴리오 편입 시 비중 축소 및 제외를 권고합니다.

### 6.4 워크플로우 예시

* **1일 호라이즌 (1d) 분석 예시** :
  * **Top-3 섹터** : Energy, Financial Services, Technology 선정.
  * **산업 분석** : 해당 섹터 내 45개 산업을 개선된 5단계 로직으로 분류.
  * **결과** : 성격이 명확히 구분된 `20260116_1d_cluster_*.csv` 파일 생성.
* **1개월 호라이즌 (1m) 분석 예시** :
  * **Top-3 섹터** : Healthcare, Technology, Consumer Defensive 선정.
  * **산업 분석** : 해당 섹터 내 52개 산업 정밀 분류.
  * **결과** : Cluster 1(강력 매수) 그룹 집중 리포팅.

각 호라이즌은 독립적으로 분석되므로, 투자 시계에 따라 서로 다른 주도 섹터와 유망 산업군을 확인할 수 있습니다.

---

## 7. 시스템 출력 및 활용

파이프라인 실행 결과는 `Data_set/Cluster_Results/` 경로에 체계적으로 저장됩니다.

### 7.1 상세 출력 목록

* **CSV 파일 (총 42개)** :
* **산업 특성 파일** :`{date}_{horizon}_industry_features.csv` (7개 호라이즌별 1개)
* **클러스터별 목록** :`{date}_{horizon}_cluster_{n}.csv` (7개 호라이즌 ×**5개 클러스터** = 35개)
* **Tableau 연동** : 생성된 CSV 데이터를 기반으로 섹터 로테이션 히트맵 및 Risk-Reward 산점도 시각화 가능.

## 8. 향후 발전 계획

1. **데이터 업데이트** : 최신 시장 데이터를 반영하여 정기적인 파이프라인 실행 및 결과 갱신.
2. **시각화 강화** : Tableau를 활용하여 클러스터별 Risk-Reward 산점도 시각화 대시보드 구축.
3. **포트폴리오 자동화** : 클러스터 분석 결과를 기반으로 한 최적 자산 배분 알고리즘 연동.

---

## 9. 부록: 주요 용어 설명

* **yhat (예측값)** : AI 모델이 계산한 미래의 예상 가격 또는 수익률입니다. 쉽게 말해, "내일 또는 다음 달에 이 주식의 값이 얼마가 될까?"라는 질문에 대한 AI의 답변입니다.
* **alpha (알파, 하이브리드 가중치)** : 두 가지 AI 모델(전체적인 흐름을 보는 Prophet과 미세한 변화를 잡는 XGBoost)의 의견을 어떤 비율로 섞을지 결정하는 값입니다. 현재 설정된**alpha=0.6**은 최근의 오차를 수정하는 데 더 큰 비중을 두어, 시장 변화에 더 민감하게 반응하도록 설계되었음을 뜻합니다.
* **gamma (감마, 신뢰도 가중치)** : 추천 순위를 정할 때 '높은 수익'과 '확실한 예측' 중 무엇을 더 중요하게 생각할지 정하는 기준입니다. 이 값이 높을수록 단순히 수익률만 높은 것보다, AI가 맞출 확률이 높다고 판단하는 안전한 대상을 상위권에 배치합니다.
* **MDD (Maximum Drawdown, 최대 낙폭)** : 투자 기간 중 최고점에서 최저점까지 얼마나 떨어졌는지를 나타내는 지표입니다. "내가 이 투자를 했을 때 겪을 수 있는 최악의 손실은 얼마인가?"를 보여주며, 수치가 0에 가까울수록 하락장에서 잘 버틴 산업입니다.
* **NDCG (Normalized Discounted Cumulative Gain, 순위 정확도)** : AI가 추천한 종목들의 순위가 실제 시장의 성과 순위와 얼마나 일치하는지 평가하는 점수입니다. 1점에 가까울수록 AI가 유망한 종목을 정확한 순서대로 잘 골라냈다는 뜻입니다.
* **Sharpe Ratio (샤프 지수, 투자 가성비)** : 위험(변동성)을 1만큼 감수했을 때 얻을 수 있는 추가 수익을 말합니다. 단순히 수익이 높은 것이 아니라, 얼마나 "효율적으로" 돈을 벌었는지 보여주는 지표로, 수치가 높을수록 가성비 좋은 투자처입니다.
* **Volatility (변동성)** : 가격이 위아래로 출렁이는 정도입니다. 변동성이 크다는 것은 짧은 시간에 큰 돈을 벌 수도 있지만, 반대로 큰 손해를 볼 위험도 크다는 것을 의미합니다.
* **Horizon (시간 지평)** : 분석 대상이 되는 미래의 기간입니다. 우리 시스템은 1일(1d)부터 1년(1y)까지 총 7가지 기간을 분석하여, 단기 투자자와 장기 투자자 모두에게 맞는 전략을 제공합니다.
* **Z-Score (표준 점수)** : 현재의 수치가 평소(평균)와 비교했을 때 얼마나 특별하게 높거나 낮은지를 나타내는 점수입니다. 서로 다른 기준을 가진 데이터들을 공평하게 비교하기 위해 사용합니다.
* **Residual (잔차, 예측 오차)** : 실제 결과와 AI의 예측값 사이의 차이입니다. 우리 시스템은 이 오차를 버리지 않고 다시 한번 학습하여, 모델이 놓친 미세한 패턴까지 잡아냅니다.
* **OHLCV** : 주식의 가격 움직임을 나타내는 5가지 핵심 데이터인 시가(Open), 고가(High), 저가(Low), 종가(Close), 거래량(Volume)의 약자입니다.
* **Residual Correction (잔차 보정)** : 첫 번째 모델(Prophet)이 놓친 오차를 두 번째 모델(XGBoost)이 보완하여 최종 예측의 정확도를 높이는 하이브리드 방식의 핵심 기술입니다.
